generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// AUTHENTICATION & USERS
// ============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  password      String?
  image         String?
  role          UserRole  @default(OFFICER)
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Security fields
  failedLoginAttempts Int       @default(0)
  lastFailedLoginAt   DateTime?

  // Relations
  accounts              Account[]
  sessions              Session[]
  assignedStores        StoreAssignment[]
  createdStores         Store[]            @relation("CreatedBy")
  updatedStores         Store[]            @relation("UpdatedBy")
  createdEvidences      Evidence[]         @relation("EvidenceCreatedBy")
  verifiedEvidences     Evidence[]         @relation("EvidenceVerifiedBy")
  createdActions        CorrectiveAction[] @relation("ActionCreatedBy")
  assignedActions       CorrectiveAction[] @relation("ActionAssignedTo")
  createdAudits         Audit[]            @relation("AuditCreatedBy")
  auditComments         AuditComment[]
  notifications         Notification[]
  activityLogs          ActivityLog[]
  escalations           Escalation[]       @relation("EscalationCreatedBy")
  escalationsAssignedTo Escalation[]       @relation("EscalationAssignedTo")

  @@map("users")
}

enum UserRole {
  ADMIN
  OFFICER
  TENANT
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================================
// STORES & LOCATIONS
// ============================================================================

model Store {
  id              String           @id @default(cuid())
  storeCode       String           @unique
  name            String
  tradeName       String?
  zone            String
  floor           String?
  precinct        String?
  storeType       StoreType
  highFootTraffic Boolean          @default(false)
  tradingHours    String?
  tenantContact   String?
  tenantEmail     String?
  tenantPhone     String?
  status          String           @default("active") // active, closed, under-renovation
  overallStatus   ComplianceStatus @default(GREY)
  priorityScore   Int              @default(0)
  lastAuditDate   DateTime?
  nextAuditDue    DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  createdById     String?
  updatedById     String?

  // Relations
  createdBy         User?              @relation("CreatedBy", fields: [createdById], references: [id])
  updatedBy         User?              @relation("UpdatedBy", fields: [updatedById], references: [id])
  assignments       StoreAssignment[]
  complianceItems   ComplianceItem[]
  evidences         Evidence[]
  audits            Audit[]
  correctiveActions CorrectiveAction[]
  activityLogs      ActivityLog[]
  escalations       Escalation[]

  @@index([zone])
  @@index([storeType])
  @@index([overallStatus])
  @@index([priorityScore])
  @@map("stores")
}

enum StoreType {
  FB // Food & Beverage
  RETAIL
  SERVICES
  LUXURY
  ATTRACTION
  POPUP
}

enum ComplianceStatus {
  GREEN // Compliant
  ORANGE // Expiring soon
  RED // Expired/Missing/Non-compliant
  GREY // Not applicable
}

model StoreAssignment {
  id         String   @id @default(cuid())
  storeId    String
  userId     String
  assignedAt DateTime @default(now())
  assignedBy String?
  active     Boolean  @default(true)

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([storeId, userId])
  @@index([userId])
  @@map("store_assignments")
}

// ============================================================================
// COMPLIANCE TRACKING
// ============================================================================

model ComplianceItem {
  id                String             @id @default(cuid())
  storeId           String
  category          ComplianceCategory
  subCategory       String?
  status            ComplianceStatus   @default(GREY)
  required          Boolean            @default(true)
  expiryDate        DateTime?
  lastVerifiedDate  DateTime?
  verificationNotes String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  store     Store      @relation(fields: [storeId], references: [id], onDelete: Cascade)
  evidences Evidence[]

  @@unique([storeId, category, subCategory])
  @@index([category])
  @@index([status])
  @@index([expiryDate])
  @@map("compliance_items")
}

enum ComplianceCategory {
  OHS_RISK_ASSESSMENT
  EXTRACTION_CERT
  FIRE_SUPPRESSION_CERT
  FIRE_EQUIPMENT
  TRAINING
  FIRST_AID
  SHOP_AUDIT
}

model Evidence {
  id                 String             @id @default(cuid())
  complianceItemId   String
  storeId            String
  title              String
  description        String?
  fileUrl            String?
  fileName           String?
  fileType           String?
  fileSize           Int?
  issueDate          DateTime?
  expiryDate         DateTime?
  verificationStatus VerificationStatus @default(PENDING)
  verifiedById       String?
  verifiedAt         DateTime?
  rejectionReason    String?
  createdById        String
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  complianceItem ComplianceItem @relation(fields: [complianceItemId], references: [id], onDelete: Cascade)
  store          Store          @relation(fields: [storeId], references: [id], onDelete: Cascade)
  createdBy      User           @relation("EvidenceCreatedBy", fields: [createdById], references: [id])
  verifiedBy     User?          @relation("EvidenceVerifiedBy", fields: [verifiedById], references: [id])

  @@index([complianceItemId])
  @@index([storeId])
  @@index([verificationStatus])
  @@map("evidences")
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

// ============================================================================
// AUDITS & INSPECTIONS (Restaurant Audit Module)
// ============================================================================

model AuditTemplate {
  id          String      @id @default(cuid())
  name        String
  description String?
  storeTypes  StoreType[]
  version     String      @default("1.0")
  active      Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  sections AuditSection[]
  audits   Audit[]

  @@map("audit_templates")
}

model AuditSection {
  id          String  @id @default(cuid())
  templateId  String
  name        String // e.g., "Fire, Emergency & Safety Management"
  description String?
  weight      Int     @default(1) // For weighted scoring
  order       Int     @default(0)

  template  AuditTemplate   @relation(fields: [templateId], references: [id], onDelete: Cascade)
  questions AuditQuestion[]

  @@index([templateId])
  @@map("audit_sections")
}

model AuditQuestion {
  id          String  @id @default(cuid())
  sectionId   String
  question    String // e.g., "Fire extinguishers accessible, serviced, compliant?"
  description String? // Additional context
  critical    Boolean @default(false) // If true, failure triggers "Restaurant Critical" flag
  order       Int     @default(0)

  section   AuditSection    @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  responses AuditResponse[]

  @@index([sectionId])
  @@map("audit_questions")
}

model Audit {
  id                  String      @id @default(cuid())
  storeId             String
  templateId          String
  conductedById       String
  auditDate           DateTime
  status              AuditStatus @default(DRAFT)
  overallScore        Float? // Overall compliance % (0-100)
  sectionScores       Json? // { "sectionId": { "score": 85.5, "yes": 5, "no": 1, "na": 2 } }
  generalComments     String?
  tenantAcknowledged  Boolean     @default(false)
  tenantName          String?
  tenantRole          String?
  tenantContact       String?
  officerSignatureUrl String?
  officerSignedAt     DateTime?
  managerSignatureUrl String?
  managerSignedAt     DateTime?
  managerVerifiedById String?
  managerVerifiedAt   DateTime?
  rejectionReason     String?
  geoProofCaptured    Boolean     @default(false)
  geoLat              Float?
  geoLng              Float?
  geoAccuracyMeters   Float?
  geoStatus           GeoStatus?
  zoneMatch           Boolean?
  lastSyncedAt        DateTime? // For offline mode
  completedAt         DateTime?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  store           Store                 @relation(fields: [storeId], references: [id], onDelete: Cascade)
  template        AuditTemplate         @relation(fields: [templateId], references: [id])
  conductedBy     User                  @relation("AuditCreatedBy", fields: [conductedById], references: [id])
  responses       AuditResponse[]
  actions         CorrectiveAction[]
  comments        AuditComment[]
  signatures      AuditSignature[]
  acknowledgement AuditAcknowledgement?

  @@index([storeId])
  @@index([status])
  @@index([auditDate])
  @@index([overallScore])
  @@map("audits")
}

enum AuditStatus {
  DRAFT // Officer is still filling it out
  SUBMITTED // Officer submitted (locked)
  MEDIA_UPLOADING // Photos still uploading
  COMPLETE // All data + media uploaded
  VERIFIED // Manager verified and signed
  REJECTED // Manager rejected, needs revision
  ARCHIVED // Old/historical
}

enum GeoStatus {
  CAPTURED
  DENIED
  UNAVAILABLE
}

model AuditResponse {
  id                   String          @id @default(cuid())
  auditId              String
  questionId           String
  result               AuditResult // YES, NO, NA
  notes                String?
  severity             ActionSeverity? // Required if result = NO
  createdActionId      String? // Auto-created corrective action
  sectionScoreSnapshot Float? // Section score at time of response
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt

  audit    Audit         @relation(fields: [auditId], references: [id], onDelete: Cascade)
  question AuditQuestion @relation(fields: [questionId], references: [id])
  photos   AuditPhoto[]

  @@unique([auditId, questionId])
  @@index([auditId])
  @@index([result])
  @@map("audit_responses")
}

enum AuditResult {
  YES // Compliant
  NO // Non-compliant (requires note + photo + severity)
  NA // Not applicable
}

model AuditPhoto {
  id                String     @id @default(cuid())
  responseId        String
  auditId           String
  photoUrl          String
  fileName          String?
  fileSize          Int?
  uploadedById      String
  uploadedAt        DateTime   @default(now())
  geoLat            Float?
  geoLng            Float?
  geoAccuracyMeters Float?
  geoStatus         GeoStatus?
  deviceInfo        String? // User agent or device type

  response AuditResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)

  @@index([responseId])
  @@index([auditId])
  @@map("audit_photos")
}

model AuditSignature {
  id           String        @id @default(cuid())
  auditId      String
  signedById   String
  role         SignatureRole
  signatureUrl String
  ipAddress    String?
  deviceInfo   String?
  createdAt    DateTime      @default(now())

  audit Audit @relation(fields: [auditId], references: [id], onDelete: Cascade)

  @@index([auditId])
  @@map("audit_signatures")
}

enum SignatureRole {
  OFFICER
  MANAGER
}

model AuditAcknowledgement {
  id           String   @id @default(cuid())
  auditId      String   @unique
  acknowledged Boolean  @default(false)
  name         String?
  role         String? // e.g., "Manager on Duty", "Head Chef"
  contact      String? // Phone or email
  createdAt    DateTime @default(now())

  audit Audit @relation(fields: [auditId], references: [id], onDelete: Cascade)

  @@map("audit_acknowledgements")
}

model AuditComment {
  id        String   @id @default(cuid())
  auditId   String
  userId    String
  comment   String
  createdAt DateTime @default(now())

  audit Audit @relation(fields: [auditId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id])

  @@index([auditId])
  @@map("audit_comments")
}

// QR Code for each store (links to latest audit summary)
model StoreQRCode {
  id             String    @id @default(cuid())
  storeId        String    @unique
  qrImageUrl     String?
  publicToken    String?   @unique // Signed token for public access
  tokenExpiresAt DateTime?
  generatedAt    DateTime  @default(now())
  lastAccessedAt DateTime?
  accessCount    Int       @default(0)

  @@index([publicToken])
  @@map("store_qr_codes")
}

// ============================================================================
// CORRECTIVE ACTIONS
// ============================================================================

model CorrectiveAction {
  id           String              @id @default(cuid())
  storeId      String
  auditId      String?
  title        String
  description  String
  severity     ActionSeverity
  category     ComplianceCategory?
  status       ActionStatus        @default(OPEN)
  dueDate      DateTime
  completedAt  DateTime?
  createdById  String
  assignedToId String?
  photoUrls    String[]
  resolution   String?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  store      Store       @relation(fields: [storeId], references: [id], onDelete: Cascade)
  audit      Audit?      @relation(fields: [auditId], references: [id])
  createdBy  User        @relation("ActionCreatedBy", fields: [createdById], references: [id])
  assignedTo User?       @relation("ActionAssignedTo", fields: [assignedToId], references: [id])
  escalation Escalation?

  @@index([storeId])
  @@index([status])
  @@index([dueDate])
  @@index([severity])
  @@map("corrective_actions")
}

enum ActionSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ActionStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
  ESCALATED
}

model Escalation {
  id           String    @id @default(cuid())
  actionId     String    @unique
  storeId      String
  reason       String
  createdById  String
  assignedToId String?
  status       String    @default("open") // open, acknowledged, resolved
  resolvedAt   DateTime?
  resolution   String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  action     CorrectiveAction @relation(fields: [actionId], references: [id], onDelete: Cascade)
  store      Store            @relation(fields: [storeId], references: [id])
  createdBy  User             @relation("EscalationCreatedBy", fields: [createdById], references: [id])
  assignedTo User?            @relation("EscalationAssignedTo", fields: [assignedToId], references: [id])

  @@index([status])
  @@map("escalations")
}

// ============================================================================
// NOTIFICATIONS & CALENDAR
// ============================================================================

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  link      String?
  read      Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  EXPIRY_30_DAYS
  EXPIRY_14_DAYS
  EXPIRY_7_DAYS
  EXPIRED
  ACTION_OVERDUE
  ACTION_ASSIGNED
  ESCALATION
  AUDIT_DUE
  WEEKLY_DIGEST
}

model PeakPeriod {
  id        String   @id @default(cuid())
  name      String
  startDate DateTime
  endDate   DateTime
  tag       String // Holiday, Cruise Week, Event Weekend
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([startDate, endDate])
  @@map("peak_periods")
}

// ============================================================================
// SETTINGS & CONFIGURATION
// ============================================================================

model SystemSettings {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  updatedAt   DateTime @updatedAt

  @@map("system_settings")
}

model Zone {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  active      Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())

  @@map("zones")
}

// ============================================================================
// ACTIVITY & AUDIT TRAIL
// ============================================================================

model ActivityLog {
  id        String   @id @default(cuid())
  storeId   String?
  userId    String?
  action    String
  entity    String // Store, Evidence, Action, Audit, etc.
  entityId  String
  details   String? // JSON string
  createdAt DateTime @default(now())

  store Store? @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user  User?  @relation(fields: [userId], references: [id])

  @@index([storeId])
  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("activity_logs")
}
